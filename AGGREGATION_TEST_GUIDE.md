# 🧪 聚合查询功能测试指南

## 📊 测试环境
- **开发服务器**: http://localhost:3000
- **测试时间**: 2026-02-10
- **测试版本**: v3.1-dev

---

## 🎯 测试目标

验证AI助手能否正确处理聚合统计查询，包括：
1. 基础统计（计数）
2. 分组统计
3. 平均值计算
4. 对比分析

---

## 📋 测试用例

### 测试1: 基础计数查询 ⭐优先

#### 测试1.1: 高风险商户统计
**输入**: "这个月有多少高风险商户？"

**预期结果**:
- ✅ AI理解为聚合查询
- ✅ 返回数字: **2个**
- ✅ 可能列出商户名称（M001海底捞等）

**验证点**:
- [ ] 回答包含"2"或"2个"
- [ ] 没有答非所问
- [ ] 格式清晰

---

#### 测试1.2: 餐饮类商户统计
**输入**: "餐饮类商户有几个？"

**预期结果**:
- ✅ AI理解为聚合查询
- ✅ 返回餐饮类商户数量
- ✅ 可能列出部分商户名称

**验证点**:
- [ ] 回答包含具体数字
- [ ] 识别出"餐饮类"筛选条件
- [ ] 格式清晰

---

### 测试2: 分组统计查询

#### 测试2.1: 按风险等级分组
**输入**: "按风险等级统计商户数量"

**预期结果**:
- ✅ AI理解为分组聚合查询
- ✅ 返回各风险等级的数量:
  - 高风险 (high): 2个
  - 中风险 (medium): 3个
  - 低风险 (low): 9个
  - 无风险 (none): 4个

**验证点**:
- [ ] 包含所有风险等级
- [ ] 数字准确
- [ ] 格式清晰（表格或列表）

---

### 测试3: 平均值计算

#### 测试3.1: 整体平均健康度
**输入**: "所有商户的平均健康度是多少？"

**预期结果**:
- ✅ AI理解为平均值查询
- ✅ 返回平均健康度分数
- ✅ 可能提供上下文（如"处于中等水平"）

**验证点**:
- [ ] 回答包含具体分数
- [ ] 计算准确
- [ ] 有上下文解释

---

#### 测试3.2: 分类平均健康度
**输入**: "餐饮类商户的平均健康度是多少？"

**预期结果**:
- ✅ AI理解为带筛选的平均值查询
- ✅ 返回餐饮类商户的平均健康度
- ✅ 可能与整体平均值对比

**验证点**:
- [ ] 回答包含具体分数
- [ ] 只统计餐饮类商户
- [ ] 有对比或解释

---

### 测试4: 对比分析 ⚠️ 可能未实现

#### 测试4.1: 时间对比
**输入**: "这个月高风险商户比上个月多了几个？"

**预期结果**:
- ✅ AI理解为对比查询
- ✅ 返回对比结果（增加/减少）
- ✅ 提供趋势分析

**验证点**:
- [ ] 回答包含对比数据
- [ ] 说明增加或减少
- [ ] 有趋势分析

**注意**: 如果AI回答"暂无历史数据"或"功能开发中"，属于正常情况。

---

## 🔍 调试方法

### 如果AI答非所问

1. **检查query-analyzer**
   - 打开浏览器控制台（F12）
   - 查看是否有 `[AgentRouter] Structured query:` 日志
   - 确认 `type` 是否为 `aggregation`

2. **检查aggregation-executor**
   - 查看是否有 `[AggregationExecutor]` 日志
   - 确认执行结果是否正确

3. **检查response-generator**
   - 查看生成的响应内容
   - 确认是否包含统计数据

### 如果统计数字错误

1. **验证数据源**
   ```javascript
   // 在浏览器控制台运行
   const merchants = JSON.parse(localStorage.getItem('merchants'));
   console.log('总商户数:', merchants.length);
   console.log('高风险:', merchants.filter(m => m.riskLevel === 'high').length);
   console.log('中风险:', merchants.filter(m => m.riskLevel === 'medium').length);
   console.log('低风险:', merchants.filter(m => m.riskLevel === 'low').length);
   console.log('无风险:', merchants.filter(m => m.riskLevel === 'none').length);
   ```

2. **检查筛选逻辑**
   - 查看aggregation-executor的筛选代码
   - 确认筛选条件是否正确应用

---

## 📊 预期数据参考

### 当前商户统计（2026-02-10）
- **总商户数**: 18个
- **风险分布**:
  - 高风险 (high): 2个
  - 中风险 (medium): 3个
  - 低风险 (low): 9个
  - 无风险 (none): 4个

### 平均健康度（估算）
- **整体平均**: 约75-80分
- **餐饮类平均**: 需实际计算
- **零售类平均**: 需实际计算

---

## ✅ 测试完成标准

### 必须通过（P0）
- [x] 测试1.1: 高风险商户统计
- [x] 测试2.1: 按风险等级分组
- [x] 测试3.1: 整体平均健康度

### 应该通过（P1）
- [ ] 测试1.2: 餐饮类商户统计
- [ ] 测试3.2: 分类平均健康度

### 可以失败（P2）
- [ ] 测试4.1: 时间对比（可能未实现历史数据）

---

## 📝 测试记录模板

```markdown
### 测试记录 - [日期时间]

#### 测试1.1: 高风险商户统计
- 输入: "这个月有多少高风险商户？"
- 实际回答: [粘贴AI回答]
- 结果: ✅通过 / ❌失败
- 问题: [如有问题，描述]

#### 测试2.1: 按风险等级分组
- 输入: "按风险等级统计商户数量"
- 实际回答: [粘贴AI回答]
- 结果: ✅通过 / ❌失败
- 问题: [如有问题，描述]

...
```

---

## 🚀 开始测试

1. 访问 http://localhost:3000
2. 点击右下角AI助手图标（蓝紫渐变，带✨图标）
3. 依次输入测试用例
4. 记录测试结果
5. 如有问题，查看浏览器控制台日志

**祝测试顺利！** 🎉
