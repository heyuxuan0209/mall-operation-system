# Phase 1 å®æ–½æ–‡æ¡£ï¼šåŸºç¡€ä¼˜åŒ–

> å®æ–½æ—¶é—´ï¼š2024-01
> çŠ¶æ€ï¼šâœ… å·²å®Œæˆ

## å®æ–½å†…å®¹

### 1. æŸ¥è¯¢ç¼“å­˜ï¼ˆLayer 0ï¼‰

**æ–‡ä»¶**ï¼š`skills/ai-assistant/query-cache.ts`

**åŠŸèƒ½**ï¼š
- ç¼“å­˜æ„å›¾è¯†åˆ«ç»“æœï¼Œå‡å°‘é‡å¤è®¡ç®—
- TTLï¼š1å°æ—¶
- æœ€å¤§ç¼“å­˜ï¼š1000æ¡
- è‡ªåŠ¨æ¸…ç†è¿‡æœŸç¼“å­˜

**å…³é”®ä»£ç **ï¼š
```typescript
export class QueryCache {
  private cache = new Map<string, CachedResult>();
  private ttl = 3600000; // 1å°æ—¶
  private maxSize = 1000;

  get(query: string): IntentResult | null {
    const normalized = this.normalize(query);
    const cached = this.cache.get(normalized);

    if (cached && Date.now() - cached.timestamp < this.ttl) {
      return cached.result;
    }
    return null;
  }
}
```

**é¢„æœŸæ•ˆæœ**ï¼š
- ç¼“å­˜å‘½ä¸­ç‡ï¼š> 30%
- å“åº”æ—¶é—´ï¼š< 5msï¼ˆå‘½ä¸­æ—¶ï¼‰
- Tokenæ¶ˆè€—ï¼š0

### 2. ç½®ä¿¡åº¦é˜ˆå€¼åˆ¤æ–­ï¼ˆLayer 2ä¼˜åŒ–ï¼‰

**æ–‡ä»¶**ï¼š`skills/ai-assistant/intent-classifier.ts`

**åŠŸèƒ½**ï¼š
- å…³é”®è¯åˆ†ç±»åè¯„ä¼°ç½®ä¿¡åº¦
- ç½®ä¿¡åº¦ >= 0.7ï¼šç›´æ¥ä½¿ç”¨ï¼Œè·³è¿‡LLM
- ç½®ä¿¡åº¦ < 0.7ï¼šè°ƒç”¨LLM

**å…³é”®ä»£ç **ï¼š
```typescript
// Layer 2: å…³é”®è¯åˆ†ç±» + ç½®ä¿¡åº¦é˜ˆå€¼
const keywordResult = this.classifyWithContext(input, context);

if (keywordResult.confidence >= 0.7) {
  console.log('[IntentClassifier] Confidence sufficient, skipping LLM');
  queryCache.set(input, keywordResult);
  return [keywordResult];
}

// Layer 3: LLMåˆ†æï¼ˆåªåœ¨å¿…è¦æ—¶ï¼‰
console.log('[IntentClassifier] Confidence < 0.7, using LLM');
```

**é¢„æœŸæ•ˆæœ**ï¼š
- LLMè°ƒç”¨ç‡ï¼šä» 100% é™è‡³ < 15%
- Tokenæ¶ˆè€—ï¼šé™ä½ 85%

### 3. æ€§èƒ½ç›‘æ§

**æ–‡ä»¶**ï¼š`skills/ai-assistant/performance-monitor.ts`

**åŠŸèƒ½**ï¼š
- è®°å½•æ¯æ¬¡åˆ†ç±»çš„æ€§èƒ½æŒ‡æ ‡
- ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
- æ£€æŸ¥æ˜¯å¦è¾¾åˆ°ç›®æ ‡æŒ‡æ ‡

**ç›‘æ§æŒ‡æ ‡**ï¼š
```typescript
interface ClassificationMetrics {
  method: 'cache' | 'forced_rule' | 'keyword' | 'llm' | 'fallback';
  responseTime: number;
  tokenUsage?: number;
  confidence: number;
  intent: string;
  timestamp: number;
}
```

**æŠ¥å‘Šå†…å®¹**ï¼š
- æ€»æŸ¥è¯¢æ•°
- å„å±‚å‘½ä¸­ç‡
- å¹³å‡å“åº”æ—¶é—´
- å¹³å‡Tokenæ¶ˆè€—
- ä¼°ç®—æœˆåº¦æˆæœ¬
- å¹³å‡ç½®ä¿¡åº¦

### 4. åˆ†å±‚æ¶æ„é›†æˆ

**å®Œæ•´æµç¨‹**ï¼š
```
ç”¨æˆ·è¾“å…¥
  â†“
Layer 0: ç¼“å­˜æŸ¥è¯¢ (0 token, <5ms)
  â†“ (æœªå‘½ä¸­)
Layer 1: å¼ºåˆ¶è§„åˆ™ (0 token, <10ms)
  â†“ (æœªåŒ¹é…)
Layer 2: å…³é”®è¯åˆ†ç±» (0 token, <50ms)
  â”œâ”€ ç½®ä¿¡åº¦ >= 0.7 â†’ ç›´æ¥è¿”å›
  â””â”€ ç½®ä¿¡åº¦ < 0.7 â†’ ç»§ç»­
  â†“
Layer 3: LLMåˆ†æ (~200 token, <1s)
  â†“
è¿”å›ç»“æœ + è®°å½•æ€§èƒ½æŒ‡æ ‡
```

## æµ‹è¯•éªŒè¯

### æµ‹è¯•ç”¨ä¾‹

#### ç”¨ä¾‹1ï¼šç¼“å­˜å‘½ä¸­
```
è¾“å…¥ï¼šæµ·åº•ææœ€è¿‘æ€ä¹ˆæ ·ï¼ˆç¬¬äºŒæ¬¡æŸ¥è¯¢ï¼‰
é¢„æœŸï¼šLayer 0 å‘½ä¸­ï¼Œ< 5ms
å®é™…ï¼šå¾…æµ‹è¯•
```

#### ç”¨ä¾‹2ï¼šå¼ºåˆ¶è§„åˆ™åŒ¹é…
```
è¾“å…¥ï¼šæˆ‘æƒ³çœ‹ä¸‹æµ·åº•æçš„å†å²å¸®æ‰¶æ¡£æ¡ˆ
é¢„æœŸï¼šLayer 1 å‘½ä¸­ï¼Œ< 10ms
å®é™…ï¼šå¾…æµ‹è¯•
```

#### ç”¨ä¾‹3ï¼šå…³é”®è¯é«˜ç½®ä¿¡åº¦
```
è¾“å…¥ï¼šæµ·åº•ææœ‰ä»€ä¹ˆé—®é¢˜
é¢„æœŸï¼šLayer 2 å‘½ä¸­ï¼ˆç½®ä¿¡åº¦ > 0.7ï¼‰ï¼Œ< 50ms
å®é™…ï¼šå¾…æµ‹è¯•
```

#### ç”¨ä¾‹4ï¼šéœ€è¦LLM
```
è¾“å…¥ï¼šæµ·åº•æå¸®æ‰¶æªæ–½æ¨è¿›
é¢„æœŸï¼šLayer 3 LLMè°ƒç”¨ï¼Œ< 1s
å®é™…ï¼šå¾…æµ‹è¯•
```

### æ€§èƒ½ç›®æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å½“å‰å€¼ | çŠ¶æ€ |
|------|--------|--------|------|
| ç¼“å­˜å‘½ä¸­ç‡ | > 30% | å¾…æµ‹è¯• | ğŸ” |
| å¼ºåˆ¶è§„åˆ™ç‡ | > 50% | å¾…æµ‹è¯• | ğŸ” |
| å…³é”®è¯ç‡ | > 20% | å¾…æµ‹è¯• | ğŸ” |
| LLMè°ƒç”¨ç‡ | < 15% | å¾…æµ‹è¯• | ğŸ” |
| å¹³å‡å“åº”æ—¶é—´ | < 500ms | å¾…æµ‹è¯• | ğŸ” |
| å¹³å‡Tokenæ¶ˆè€— | < 50/query | å¾…æµ‹è¯• | ğŸ” |

## ä½¿ç”¨æ–¹æ³•

### æŸ¥çœ‹æ€§èƒ½æŠ¥å‘Š

```typescript
import { performanceMonitor } from '@/skills/ai-assistant/performance-monitor';

// æ‰“å°æ€§èƒ½æŠ¥å‘Š
performanceMonitor.printReport();

// è·å–æŠ¥å‘Šæ•°æ®
const report = performanceMonitor.getReport();
console.log(report);

// æ£€æŸ¥æ˜¯å¦è¾¾åˆ°ç›®æ ‡
const check = performanceMonitor.checkTargets();
if (!check.passed) {
  console.log('æœªè¾¾åˆ°ç›®æ ‡:', check.failures);
}
```

### æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡

```typescript
import { queryCache } from '@/skills/ai-assistant/query-cache';

// è·å–ç¼“å­˜ç»Ÿè®¡
const stats = queryCache.getStats();
console.log('ç¼“å­˜å¤§å°:', stats.size);
console.log('æœ€å¤§å®¹é‡:', stats.maxSize);
console.log('TTL:', stats.ttl);

// æ¸…ç©ºç¼“å­˜
queryCache.clear();
```

### æ‰‹åŠ¨è®°å½•æ€§èƒ½æŒ‡æ ‡

```typescript
import { performanceMonitor } from '@/skills/ai-assistant/performance-monitor';

performanceMonitor.record({
  method: 'cache',
  responseTime: 3,
  confidence: 0.95,
  intent: 'health_query',
  timestamp: Date.now()
});
```

## åç»­ä¼˜åŒ–

### Phase 2ï¼ˆè®¡åˆ’ä¸­ï¼‰
- å®ç°ç”¨æˆ·æ¾„æ¸…æœºåˆ¶ï¼ˆLayer 4ï¼‰
- æ·»åŠ åé¦ˆæ”¶é›†åŠŸèƒ½
- ä¼˜åŒ–LLM prompté•¿åº¦

### Phase 3ï¼ˆè®¡åˆ’ä¸­ï¼‰
- å®ç°ç½®ä¿¡åº¦é©±åŠ¨çš„UX
- æ·»åŠ å¤šçº§ç¼“å­˜ï¼ˆå†…å­˜ + Redisï¼‰
- æ‰¹å¤„ç†ä¼˜åŒ–

## æ³¨æ„äº‹é¡¹

1. **ç¼“å­˜å¤±æ•ˆ**ï¼š
   - ä¿®æ”¹æ„å›¾è§„åˆ™åéœ€è¦æ¸…ç©ºç¼“å­˜
   - ä½¿ç”¨ `queryCache.clear()` æ¸…ç©º

2. **æ€§èƒ½ç›‘æ§**ï¼š
   - å®šæœŸæŸ¥çœ‹æ€§èƒ½æŠ¥å‘Š
   - å…³æ³¨LLMè°ƒç”¨ç‡æ˜¯å¦è¶…æ ‡
   - ç›‘æ§æœˆåº¦æˆæœ¬

3. **ç½®ä¿¡åº¦é˜ˆå€¼**ï¼š
   - å½“å‰é˜ˆå€¼ï¼š0.7
   - å¯æ ¹æ®å®é™…æ•ˆæœè°ƒæ•´
   - é˜ˆå€¼è¶Šé«˜ï¼ŒLLMè°ƒç”¨è¶Šå¤š

4. **Tokenä¼°ç®—**ï¼š
   - å½“å‰ä½¿ç”¨ç²—ç•¥ä¼°ç®—ï¼ˆå­—ç¬¦æ•° * 1.5ï¼‰
   - å®é™…Tokenæ•°å¯èƒ½æœ‰åå·®
   - å»ºè®®ä½¿ç”¨LLM APIè¿”å›çš„å®é™…Tokenæ•°

## é—®é¢˜æ’æŸ¥

### é—®é¢˜1ï¼šç¼“å­˜å‘½ä¸­ç‡ä½
**å¯èƒ½åŸå› **ï¼š
- ç”¨æˆ·è¾“å…¥å˜åŒ–å¤§
- TTLè®¾ç½®è¿‡çŸ­
- ç¼“å­˜å®¹é‡ä¸è¶³

**è§£å†³æ–¹æ¡ˆ**ï¼š
- å¢åŠ ç¼“å­˜å®¹é‡
- å»¶é•¿TTL
- ä¼˜åŒ–normalizeé€»è¾‘

### é—®é¢˜2ï¼šLLMè°ƒç”¨ç‡é«˜
**å¯èƒ½åŸå› **ï¼š
- ç½®ä¿¡åº¦é˜ˆå€¼è¿‡é«˜
- å…³é”®è¯è§„åˆ™ä¸å®Œå–„
- å¼ºåˆ¶è§„åˆ™è¦†ç›–ä¸è¶³

**è§£å†³æ–¹æ¡ˆ**ï¼š
- é™ä½ç½®ä¿¡åº¦é˜ˆå€¼ï¼ˆå¦‚0.7 â†’ 0.65ï¼‰
- ä¼˜åŒ–å…³é”®è¯æƒé‡
- æ·»åŠ æ›´å¤šå¼ºåˆ¶è§„åˆ™

### é—®é¢˜3ï¼šå“åº”æ—¶é—´æ…¢
**å¯èƒ½åŸå› **ï¼š
- LLMè°ƒç”¨è¿‡å¤š
- ç¼“å­˜æœªç”Ÿæ•ˆ
- ç½‘ç»œå»¶è¿Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥LLMè°ƒç”¨ç‡
- æ£€æŸ¥ç¼“å­˜å‘½ä¸­ç‡
- ä¼˜åŒ–LLM prompté•¿åº¦

## æ›´æ–°æ—¥å¿—

| æ—¥æœŸ | ç‰ˆæœ¬ | æ›´æ–°å†…å®¹ |
|------|------|----------|
| 2024-01 | v1.0 | Phase 1 åˆå§‹å®æ–½ |

---

**å®æ–½è€…**ï¼šAI Assistant Team
**å®¡æ ¸è€…**ï¼šå¾…å®š
**çŠ¶æ€**ï¼šâœ… ä»£ç å·²å®Œæˆï¼Œå¾…æµ‹è¯•éªŒè¯
