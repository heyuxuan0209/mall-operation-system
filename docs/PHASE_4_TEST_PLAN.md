# Phase 4: 端到端测试计划

## 测试目标
验证新的实体识别和消歧架构在各种场景下的正确性和性能。

---

## 测试场景

### 1. 精确匹配场景 ✅
**目的**: 验证精确匹配的高置信度识别

**测试用例**:
| 输入 | 预期商户 | 预期置信度 | 预期警告 |
|------|---------|-----------|---------|
| 海底捞火锅的健康度怎么样？ | 海底捞火锅 | ~1.0 | 无 |
| 星巴克咖啡的风险有哪些？ | 星巴克咖啡 | ~1.0 | 无 |
| 查看肯德基的营收数据 | 肯德基 | ~1.0 | 无 |

**验证点**:
- ✅ 直接返回结果，无需确认
- ✅ confidence ≥ 0.9
- ✅ 无置信度警告
- ✅ Console 显示 `source: 'exact_match'`

---

### 2. 模糊匹配场景 ⚠️
**目的**: 验证模糊匹配的中等置信度识别

**测试用例**:
| 输入 | 预期商户 | 预期置信度 | 预期警告 |
|------|---------|-----------|---------|
| 海底捞的健康度怎么样？ | 海底捞火锅 | 0.6-0.85 | 有 |
| 星巴克的风险有哪些？ | 星巴克咖啡 | 0.6-0.85 | 有 |
| 肯德基怎么样？ | 肯德基 | 0.6-0.85 | 有 |

**验证点**:
- ✅ 返回结果，但显示警告
- ✅ 警告内容："提示：我对这个理解有一定把握，但不是完全确定。"
- ✅ confidence 在 0.6-0.85 之间
- ✅ Console 显示 `source: 'fuzzy_match'`

---

### 3. 消歧场景 ❓
**目的**: 验证多个候选商户的消歧机制

**测试用例**:
| 输入 | 候选商户 | 预期行为 |
|------|---------|---------|
| 星巴克的健康度怎么样？ | 星巴克咖啡、星巴克（中关村店） | 询问用户选择 |
| 麦当劳怎么样？ | 麦当劳（王府井店）、麦当劳（三里屯店） | 询问用户选择 |

**验证点**:
- ✅ 返回消歧提示
- ✅ 列出候选商户（最多3个）
- ✅ 提示用户选择或输入完整名称
- ✅ metadata.needsClarification = true
- ✅ metadata.candidates 包含候选列表
- ✅ Console 显示 `needsClarification: true`

**后续测试**:
- 用户输入 "1" → 选择第一个候选
- 用户输入 "星巴克咖啡" → 精确匹配

---

### 4. 上下文切换场景 🔄
**目的**: 验证上下文切换检测

**测试步骤**:
1. 输入：`海底捞火锅的健康度怎么样？`
2. 输入：`星巴克咖啡的风险有哪些？`

**验证点**:
- ✅ 第一次查询：返回海底捞信息
- ✅ 第二次查询：正确切换到星巴克
- ✅ Console 显示 `shouldSwitch: true`
- ✅ Console 显示 `reason: '用户明确提到了新商户'`

---

### 5. 省略主语场景（使用上下文） 💬
**目的**: 验证智能上下文使用

**测试步骤**:
1. 输入：`海底捞火锅的健康度怎么样？`
2. 输入：`它的风险有哪些？`

**验证点**:
- ✅ 第一次查询：返回海底捞信息
- ✅ 第二次查询：自动使用上下文中的海底捞
- ✅ Console 显示来自上下文的候选
- ✅ Console 显示 `source: 'context'`
- ✅ confidence ≈ 0.6

---

### 6. 指代消解场景 🔗
**目的**: 验证指代词的正确处理

**测试步骤**:
1. 输入：`海底捞火锅的健康度怎么样？`
2. 输入：`这家店的风险有哪些？`

**验证点**:
- ✅ "这家店" 被正确替换为 "海底捞火锅"
- ✅ Console 显示 `[EnhancedContext] Reference resolved`
- ✅ 返回海底捞的风险信息

---

### 7. 低置信度场景 ❌
**目的**: 验证无法识别商户的处理

**测试用例**:
| 输入 | 预期行为 |
|------|---------|
| 那个火锅店的健康度怎么样？ | 返回错误提示 |
| 某个商户的风险有哪些？ | 返回错误提示 |
| 它怎么样？（无上下文） | 返回错误提示 |

**验证点**:
- ✅ 返回错误："未找到匹配的商户"
- ✅ 建议用户提供更明确的商户名称
- ✅ 可能提供商户建议列表

---

### 8. 对比查询场景 📊
**目的**: 验证对比查询不会触发上下文切换

**测试步骤**:
1. 输入：`海底捞火锅的健康度怎么样？`
2. 输入：`对比星巴克咖啡和肯德基`

**验证点**:
- ✅ 第二次查询识别为对比查询
- ✅ Console 显示 `shouldSwitch: false`
- ✅ Console 显示 `reason: '用户想进行对比，不是切换上下文'`

---

## 性能测试

### 1. 响应时间
**目标**: 实体识别和消歧不应显著增加响应时间

**测试方法**:
- 记录10次查询的平均响应时间
- 对比 Phase 1 前后的响应时间

**预期结果**:
- 平均响应时间增加 < 100ms
- 95% 的查询在 2 秒内完成

### 2. 内存使用
**目标**: 新模块不应显著增加内存占用

**测试方法**:
- 监控 Node.js 进程的内存使用
- 执行100次查询后检查内存泄漏

**预期结果**:
- 内存增长 < 10MB
- 无明显内存泄漏

---

## 回归测试

### 1. 聚合查询
**测试用例**:
- "有多少个高风险商户？"
- "统计所有商户的健康度"

**验证点**:
- ✅ 正确识别为聚合查询
- ✅ 返回聚合结果

### 2. 趋势分析
**测试用例**:
- "海底捞火锅的营收趋势"
- "最近一个月的客流变化"

**验证点**:
- ✅ 正确识别为趋势分析
- ✅ 返回趋势数据

---

## 调试工具

### Console 日志检查点
在浏览器开发者工具中查看以下日志：

1. **上下文切换检测**:
   ```
   [AgentRouter] Context switch detection: {
     shouldSwitch: boolean,
     confidence: number,
     reason: string
   }
   ```

2. **实体识别候选**:
   ```
   [AgentRouter] Entity recognition candidates: [
     { merchantId, merchantName, confidence, source }
   ]
   ```

3. **消歧结果**:
   ```
   [AgentRouter] Disambiguation result: {
     matched: boolean,
     merchantId?: string,
     confidence: number,
     needsClarification?: boolean
   }
   ```

4. **置信度决策**:
   ```
   [AgentRouter] Confidence decision: {
     execute: boolean,
     askConfirmation: boolean,
     showWarning: boolean,
     reason: string
   }
   ```

---

## 测试记录表

| 场景 | 测试用例 | 状态 | 实际结果 | 问题 |
|------|---------|------|---------|------|
| 精确匹配 | 海底捞火锅的健康度 | ⏳ | | |
| 模糊匹配 | 海底捞的健康度 | ⏳ | | |
| 消歧 | 星巴克的健康度 | ⏳ | | |
| 上下文切换 | 海底捞 → 星巴克 | ⏳ | | |
| 省略主语 | 它的风险 | ⏳ | | |
| 指代消解 | 这家店的风险 | ⏳ | | |
| 低置信度 | 那个火锅店 | ⏳ | | |
| 对比查询 | 对比星巴克和肯德基 | ⏳ | | |

---

## 已知问题和待优化项

### 待优化
1. [ ] 如果 LLM 分析失败，fallback 逻辑是否正确？
2. [ ] 消歧提示的用户体验是否友好？
3. [ ] 置信度阈值是否需要调整？

### 待修复
（测试过程中发现的问题将记录在此）

---

## 测试完成标准

- ✅ 所有8个场景测试通过
- ✅ 性能测试达标
- ✅ 回归测试通过
- ✅ 无严重 bug
- ✅ 文档更新完成
