# Phase 5: 端到端测试指南

## 测试环境
- **URL**: http://localhost:3000/inspection
- **浏览器**: Chrome/Safari (建议使用 Chrome DevTools)
- **测试设备**: 桌面端 + 移动端（Chrome DevTools 移动模拟）

## 测试前准备

### 1. 清空测试数据
打开浏览器控制台 (F12)，执行：
```javascript
// 清空所有测试数据
localStorage.clear();

// 或者只清空相关数据
localStorage.removeItem('inspection_records');
localStorage.removeItem('inspection_images');
localStorage.removeItem('merchants');
```

### 2. 检查开发服务器
确认服务器正在运行：http://localhost:3000

---

## 测试场景 1: 完整的巡店流程（正常场景）

### 目标
验证从签到到保存的完整流程，所有功能正常工作。

### 测试步骤

#### Step 1: 快捷签到
1. 访问 http://localhost:3000/inspection
2. 找到"快捷签到"模块
3. 点击"一键签到"按钮

**检查点：**
- [ ] 按钮显示加载状态
- [ ] 签到成功后显示绿色对勾
- [ ] 显示签到时间和位置信息
- [ ] 显示距离信息（如果有定位）
- [ ] 显示商户画像卡片（健康度、风险等级、预警标签等）

**预期结果：**
```
✓ 签到成功
时间: 2026-01-27 XX:XX
位置: [纬度, 经度]
距离: XX米 ✓ 在范围内
```

#### Step 2: 拍照记录（测试照片分类）
1. 滚动到"拍照记录"模块
2. 点击"选择图片"按钮，上传一张图片（或点击"拍照"）

**检查点：**
- [ ] 上传后自动弹出"照片分类"弹窗
- [ ] 弹窗显示照片预览
- [ ] 显示三个分类选项（👥人/📦货/🏪场）

3. 选择"场（环境）"分类

**检查点：**
- [ ] 分类按钮高亮显示
- [ ] 下方出现对应的标签选项（环境整洁、灯光明亮等）

4. 选择标签"环境整洁"和"灯光明亮"

**检查点：**
- [ ] 标签可以多选
- [ ] 选中的标签有视觉反馈（打勾）

5. 选择问题等级"良好"
6. 在备注中输入"店面环境很好，灯光充足"
7. 点击"确认"按钮

**检查点：**
- [ ] 弹窗关闭
- [ ] 照片出现在下方的网格中
- [ ] 照片上显示分类标签（🏪 场）
- [ ] 照片上显示等级标签（良好）
- [ ] 悬停照片时显示标签详情

8. 再上传两张照片：
   - 照片2: 商品（陈列混乱，警告）
   - 照片3: 人员（服务态度，良好）

**检查点：**
- [ ] 每张照片都经过分类流程
- [ ] 照片计数更新（3/5）
- [ ] 出现分类筛选器按钮

9. 测试分类筛选
   - 点击"全部"→ 显示3张照片
   - 点击"场（环境）"→ 只显示1张
   - 点击"货（商品）"→ 只显示1张
   - 点击"人（员工）"→ 只显示1张

**检查点：**
- [ ] 筛选器正确过滤照片
- [ ] 按钮显示正确的数量

10. 测试取消分类
    - 上传一张新照片
    - 在分类弹窗中点击"取消"

**检查点：**
- [ ] 弹窗关闭
- [ ] 照片被删除（不出现在列表中）
- [ ] 计数不变（仍然是3/5）

#### Step 3: 语音笔记
1. 滚动到"语音笔记"模块
2. 点击红色麦克风按钮开始录音
3. 说话10秒："今天来到星巴克咖啡店，整体环境良好，但商品陈列有些混乱，建议改进"
4. 点击停止按钮

**检查点：**
- [ ] 录音时显示波形动画
- [ ] 录音时显示计时器
- [ ] 停止后显示音频播放器
- [ ] 如果支持语音识别，显示转写文本
- [ ] 可以播放录音

#### Step 4: 快速评分
1. 滚动到"快速评分"模块
2. 点击预设评分"优秀"

**检查点：**
- [ ] 所有滑块自动调整到优秀档位（85分左右）
- [ ] 预设按钮高亮

3. 手动调整各项评分：
   - 人（员工）: 85
   - 货（商品）: 60（因为陈列混乱）
   - 场（环境）: 90
   - 整体印象: 80

**检查点：**
- [ ] 滑块可以拖动
- [ ] 分数实时更新
- [ ] 显示对应的等级标签（优秀/良好等）

#### Step 5: 其他备注
1. 在"其他备注"文本框输入："建议加强商品陈列培训"

**检查点：**
- [ ] 文本框可以输入
- [ ] 支持多行文本

#### Step 6: 保存记录
1. 滚动到底部
2. 点击"保存巡店记录"按钮

**检查点：**
- [ ] 按钮可点击（不是禁用状态）
- [ ] 点击后弹出"保存成功"反馈弹窗

#### Step 7: 验证反馈弹窗
**检查点：**
- [ ] 弹窗标题：保存成功！
- [ ] 显示商户名称：星巴克咖啡
- [ ] 显示健康度变化：
  - 之前分数（65）
  - 现在分数（计算后的新分数）
  - 趋势指示器（↑/↓/—）
  - 变化值（+X 或 -X）
- [ ] 显示"改进亮点"部分：
  - [ ] 包含"环境整洁"或"灯光明亮"相关
  - [ ] 包含"员工服务态度优秀"（因为评分85）
  - [ ] 包含"现场环境整洁明亮"（因为评分90）
- [ ] 显示"需要关注"部分：
  - [ ] 包含"陈列混乱需要改进"（因为照片）
  - [ ] 可能包含"商品管理需要优化"（因为评分60）

3. 点击"知道了"按钮

**检查点：**
- [ ] 弹窗关闭
- [ ] 页面表单被重置（照片清空、评分重置等）

#### Step 8: 验证数据持久化
1. 打开浏览器控制台 (F12)
2. 执行以下代码：

```javascript
// 检查巡检记录
const records = JSON.parse(localStorage.getItem('inspection_records'));
console.log('巡检记录:', records);

// 应该有1条记录
console.log('记录数量:', records.length);

// 检查记录内容
const record = records[0];
console.log('商户名称:', record.merchantName);
console.log('照片数量:', record.photos.length);
console.log('评分:', record.rating);
console.log('问题列表:', record.issues);

// 检查商户健康度是否更新
const merchants = JSON.parse(localStorage.getItem('merchants'));
if (merchants && merchants.length > 0) {
  const merchant = merchants.find(m => m.id === 'M001');
  console.log('更新后的健康度:', merchant?.totalScore);
  console.log('风险等级:', merchant?.riskLevel);
}
```

**预期结果：**
```javascript
巡检记录: [{ id: "inspection_...", ... }]
记录数量: 1
商户名称: "星巴克咖啡"
照片数量: 3
评分: { people: 85, merchandise: 60, place: 90, overall: 80 }
问题列表: ["商品问题(陈列混乱)"]
更新后的健康度: [新分数]
风险等级: "medium" 或 "low"
```

---

## 测试场景 2: 发现严重问题的巡店

### 目标
验证问题照片和低评分对健康度的负面影响。

### 测试步骤

1. **清空数据**（控制台执行 `localStorage.clear()`）
2. **刷新页面**
3. **签到**
4. **上传3张问题照片**：
   - 照片1: 场（卫生问题，严重）
   - 照片2: 场（设施损坏，严重）
   - 照片3: 货（断货，警告）
5. **评分** (全部低分):
   - 人: 40
   - 货: 35
   - 场: 30
   - 整体: 35
6. **保存记录**

### 预期结果

**反馈弹窗应该显示：**
- 健康度大幅下降（↓ 趋势）
- 变化值为负数（如 -15 或更多）
- "需要关注"列表中包含多个严重问题：
  - "卫生问题问题严重，需立即整改"
  - "设施损坏问题严重，需立即整改"
  - "断货需要改进"
  - "员工服务需要培训提升"
  - "商品管理需要优化"
  - "现场环境需要改善"
- "改进亮点"列表为空或很少
- 新的健康度分数应该明显低于初始值（65 → 40-50）

**验证健康度计算：**
```javascript
// 控制台执行
const records = JSON.parse(localStorage.getItem('inspection_records'));
const record = records[0];
console.log('问题数量:', record.issues.length); // 应该有3个
console.log('严重问题:', record.photos.filter(p => p.issueLevel === 'critical').length); // 2个
console.log('警告问题:', record.photos.filter(p => p.issueLevel === 'warning').length); // 1个
```

**计算公式验证：**
- 初始分数: 65
- 评分影响: -10 (平均分35，低于40)
- 照片影响: -5×2 + -2×1 = -12
- 预期新分数: 65 - 10 - 12 = 43

---

## 测试场景 3: 边界情况测试

### 3.1 无照片保存
1. 签到
2. 只进行评分，不上传照片
3. 保存

**预期：**
- 可以正常保存
- 反馈弹窗只基于评分生成亮点/关注点
- 问题列表为空

### 3.2 无评分保存
1. 签到
2. 只上传照片，不进行评分
3. 保存

**预期：**
- 可以正常保存
- 健康度变化只基于照片计算
- 反馈弹窗只包含照片相关的亮点/关注点

### 3.3 达到照片上限
1. 签到
2. 尝试上传6张照片（超过限制5张）

**预期：**
- 第6张照片无法上传
- 显示已达上限提示
- 按钮变为禁用状态

### 3.4 取消所有照片
1. 上传3张照片
2. 逐个删除所有照片（点击删除按钮）

**预期：**
- 照片可以被删除
- 计数更新（3→2→1→0）
- 分类筛选器消失

### 3.5 未签到就保存
1. 不点击签到
2. 直接点击保存按钮

**预期：**
- 保存按钮显示"请先完成签到"
- 按钮为禁用状态，无法点击

---

## 测试场景 4: 移动端适配测试

### 测试步骤
1. 打开 Chrome DevTools (F12)
2. 切换到设备模拟模式 (Ctrl+Shift+M)
3. 选择 iPhone 12 Pro
4. 刷新页面

### 检查点

**布局适配：**
- [ ] 页面不横向滚动
- [ ] 所有内容在视口内可见
- [ ] 文字大小适中，易于阅读
- [ ] 按钮大小适合触摸（至少44×44px）

**拍照功能：**
- [ ] "拍照"按钮在移动端优先显示
- [ ] 点击拍照可以调用相机（模拟器中会变成文件选择）

**照片网格：**
- [ ] 照片网格适配为2列（在小屏幕上）
- [ ] 照片等比例显示，不变形

**弹窗：**
- [ ] 分类弹窗在移动端可滚动
- [ ] 反馈弹窗在移动端适配良好
- [ ] 弹窗不超出屏幕范围

**评分滑块：**
- [ ] 滑块可以用触摸拖动
- [ ] 滑块在小屏幕上不重叠

---

## 测试场景 5: 性能测试

### 5.1 照片压缩测试
1. 上传一张大图片（>5MB）

**预期：**
- 图片被自动压缩
- 压缩后小于2MB
- 上传成功

**验证：**
```javascript
// 控制台查看压缩后大小
const images = JSON.parse(localStorage.getItem('inspection_images'));
images.forEach(img => {
  const sizeInMB = (img.size / 1024 / 1024).toFixed(2);
  console.log(`图片 ${img.id}: ${sizeInMB}MB`);
});
```

### 5.2 存储容量测试
1. 连续保存多条巡检记录（10条）

**预期：**
- 所有记录都被保存
- localStorage 使用情况正常
- 页面性能不受影响

**验证：**
```javascript
// 检查记录数量
const records = JSON.parse(localStorage.getItem('inspection_records'));
console.log('总记录数:', records.length);

// 检查存储使用量
let totalSize = 0;
for (let key in localStorage) {
  if (localStorage.hasOwnProperty(key)) {
    totalSize += localStorage[key].length;
  }
}
console.log('LocalStorage 使用量:', (totalSize / 1024).toFixed(2), 'KB');
```

### 5.3 大量照片测试
1. 保存一条包含5张照片的记录
2. 再保存一条包含5张照片的记录
3. 重复5次

**预期：**
- 所有照片都被保存
- 缩略图加载流畅
- 存储使用率在合理范围内（<5MB）

---

## 测试场景 6: 数据一致性测试

### 测试步骤
1. 保存第一条巡检记录（评分: 80, 照片: 3张良好）
2. 记录此时的健康度（假设从65→70）
3. 保存第二条巡检记录（评分: 40, 照片: 2张严重）
4. 验证健康度是在第一次的基础上计算（70→55）

**验证：**
```javascript
const records = JSON.parse(localStorage.getItem('inspection_records'));

// 按时间倒序，最新的在前面
console.log('记录1时间:', records[1].createdAt);
console.log('记录2时间:', records[0].createdAt);

// 第二次保存应该基于第一次更新后的分数
// 而不是初始分数
```

---

## 测试结果记录表

### 场景 1: 完整巡店流程
- [ ] ✅ 通过 / ❌ 失败 / ⚠️ 部分通过
- 问题描述：
- 截图：

### 场景 2: 发现严重问题
- [ ] ✅ 通过 / ❌ 失败 / ⚠️ 部分通过
- 问题描述：
- 截图：

### 场景 3: 边界情况
- 3.1 无照片: [ ] ✅ / ❌ / ⚠️
- 3.2 无评分: [ ] ✅ / ❌ / ⚠️
- 3.3 照片上限: [ ] ✅ / ❌ / ⚠️
- 3.4 删除照片: [ ] ✅ / ❌ / ⚠️
- 3.5 未签到: [ ] ✅ / ❌ / ⚠️

### 场景 4: 移动端适配
- [ ] ✅ 通过 / ❌ 失败 / ⚠️ 部分通过
- 问题描述：

### 场景 5: 性能测试
- 5.1 照片压缩: [ ] ✅ / ❌ / ⚠️
- 5.2 存储容量: [ ] ✅ / ❌ / ⚠️
- 5.3 大量照片: [ ] ✅ / ❌ / ⚠️

### 场景 6: 数据一致性
- [ ] ✅ 通过 / ❌ 失败 / ⚠️ 部分通过

---

## 发现的问题 (Bug List)

| ID | 严重性 | 问题描述 | 复现步骤 | 预期行为 | 实际行为 | 状态 |
|---|---|---|---|---|---|---|
| 1 | 高/中/低 | ... | ... | ... | ... | 待修复/已修复 |

---

## 测试总结

### 测试完成度
- 通过场景: X / 6
- 发现问题: X 个（高:X, 中:X, 低:X）
- 测试覆盖率: X%

### 主要发现
1. ...
2. ...

### 建议
1. ...
2. ...

---

## 快速测试命令

在浏览器控制台执行这些命令进行快速验证：

```javascript
// 查看所有巡检记录
console.table(JSON.parse(localStorage.getItem('inspection_records')));

// 查看最新一条记录的详情
const records = JSON.parse(localStorage.getItem('inspection_records'));
console.log('最新记录:', records[0]);

// 查看商户健康度历史
const merchants = JSON.parse(localStorage.getItem('merchants'));
console.log('商户列表:', merchants);

// 计算 localStorage 总使用量
let total = 0;
for(let x in localStorage) {
  total += localStorage[x].length + x.length;
}
console.log('总使用量:', (total / 1024).toFixed(2), 'KB');

// 清空所有测试数据
// localStorage.clear();
```
