<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Phase 5 æµ‹è¯•åŠ©æ‰‹</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 40px;
      text-align: center;
    }

    .header h1 {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .header p {
      opacity: 0.9;
      font-size: 16px;
    }

    .content {
      padding: 40px;
    }

    .section {
      margin-bottom: 40px;
    }

    .section h2 {
      color: #333;
      margin-bottom: 20px;
      font-size: 24px;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }

    .button-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 25px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    .info-box {
      background: #f0f4ff;
      border-left: 4px solid #667eea;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .info-box h3 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 18px;
    }

    .info-box p {
      color: #555;
      line-height: 1.6;
      margin-bottom: 8px;
    }

    .info-box code {
      background: #e0e7ff;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 13px;
      color: #5145cd;
    }

    .log-area {
      background: #1a1a1a;
      color: #0f0;
      padding: 20px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .log-area .success {
      color: #0f0;
    }

    .log-area .error {
      color: #f00;
    }

    .log-area .info {
      color: #0af;
    }

    .checklist {
      list-style: none;
    }

    .checklist li {
      padding: 12px;
      margin-bottom: 8px;
      background: #f9fafb;
      border-radius: 6px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .checklist li:before {
      content: 'â˜';
      font-size: 20px;
      color: #667eea;
    }

    .checklist li.checked:before {
      content: 'âœ“';
      color: #10b981;
    }

    .footer {
      background: #f9fafb;
      padding: 20px 40px;
      text-align: center;
      color: #666;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ§ª Phase 5 æµ‹è¯•åŠ©æ‰‹</h1>
      <p>å·¡åº—å·¥å…·åŒ… - ç«¯åˆ°ç«¯æµ‹è¯•æ§åˆ¶å°</p>
    </div>

    <div class="content">
      <!-- å¿«é€Ÿå¼€å§‹ -->
      <div class="section">
        <h2>ğŸš€ å¿«é€Ÿå¼€å§‹</h2>
        <div class="button-group">
          <button onclick="openInspectionPage()">æ‰“å¼€å·¡æ£€é¡µé¢</button>
          <button onclick="clearAllData()">æ¸…ç©ºæµ‹è¯•æ•°æ®</button>
          <button onclick="runValidation()">è¿è¡ŒéªŒè¯è„šæœ¬</button>
          <button onclick="checkLocalStorage()">æŸ¥çœ‹å­˜å‚¨æ•°æ®</button>
        </div>
      </div>

      <!-- æ•°æ®æ“ä½œ -->
      <div class="section">
        <h2>ğŸ’¾ æ•°æ®æ“ä½œ</h2>
        <div class="button-group">
          <button onclick="viewInspectionRecords()">æŸ¥çœ‹å·¡æ£€è®°å½•</button>
          <button onclick="viewImages()">æŸ¥çœ‹ç…§ç‰‡æ•°æ®</button>
          <button onclick="viewMerchants()">æŸ¥çœ‹å•†æˆ·æ•°æ®</button>
          <button onclick="exportData()">å¯¼å‡ºæ‰€æœ‰æ•°æ®</button>
        </div>
      </div>

      <!-- æµ‹è¯•åœºæ™¯ -->
      <div class="section">
        <h2>ğŸ¯ æµ‹è¯•åœºæ™¯å¿«é€Ÿè·³è½¬</h2>
        <div class="info-box">
          <h3>ğŸ“‹ æµ‹è¯•æ¸…å•</h3>
          <ul class="checklist">
            <li>åœºæ™¯1: å®Œæ•´å·¡åº—æµç¨‹ï¼ˆæ­£å¸¸åœºæ™¯ï¼‰</li>
            <li>åœºæ™¯2: å‘ç°ä¸¥é‡é—®é¢˜çš„å·¡åº—</li>
            <li>åœºæ™¯3: è¾¹ç•Œæƒ…å†µæµ‹è¯•</li>
            <li>åœºæ™¯4: ç§»åŠ¨ç«¯é€‚é…æµ‹è¯•</li>
            <li>åœºæ™¯5: æ€§èƒ½æµ‹è¯•</li>
            <li>åœºæ™¯6: æ•°æ®ä¸€è‡´æ€§æµ‹è¯•</li>
          </ul>
          <p style="margin-top: 15px;">è¯¦ç»†æ­¥éª¤è¯·æŸ¥çœ‹: <code>docs/phase5-e2e-testing-guide.md</code></p>
        </div>
      </div>

      <!-- å¥åº·åº¦è®¡ç®—å™¨ -->
      <div class="section">
        <h2>ğŸ§® å¥åº·åº¦è®¡ç®—å™¨</h2>
        <div class="info-box">
          <h3>è®¡ç®—å…¬å¼</h3>
          <p><strong>æ–°åˆ†æ•° = æ—§åˆ†æ•° + è¯„åˆ†å½±å“ + ç…§ç‰‡å½±å“</strong></p>
          <p>è¯„åˆ†å½±å“: 80+: +5, 60-80: 0, 40-60: -5, <40: -10</p>
          <p>ç…§ç‰‡å½±å“: ä¸¥é‡: -5/ä¸ª, è­¦å‘Š: -2/ä¸ª, è‰¯å¥½: +1/ä¸ª</p>
        </div>
        <div class="button-group">
          <button onclick="testCalculation()">æµ‹è¯•è®¡ç®—é€»è¾‘</button>
          <button onclick="showExamples()">æŸ¥çœ‹ç¤ºä¾‹è®¡ç®—</button>
        </div>
      </div>

      <!-- æ—¥å¿—è¾“å‡º -->
      <div class="section">
        <h2>ğŸ“ æµ‹è¯•æ—¥å¿—</h2>
        <div class="log-area" id="logArea">ç­‰å¾…æ“ä½œ...</div>
      </div>
    </div>

    <div class="footer">
      Phase 5: ç«¯åˆ°ç«¯æµ‹è¯• | Mall Operation Agent | 2026-01-27
    </div>
  </div>

  <script>
    const log = (message, type = 'info') => {
      const logArea = document.getElementById('logArea');
      const timestamp = new Date().toLocaleTimeString();
      const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
      logArea.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
      logArea.scrollTop = logArea.scrollHeight;
    };

    const clearLog = () => {
      document.getElementById('logArea').innerHTML = '';
    };

    function openInspectionPage() {
      log('æ‰“å¼€å·¡æ£€é¡µé¢...', 'info');
      window.open('http://localhost:3000/inspection', '_blank');
      log('âœ“ å·²åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€', 'success');
    }

    function clearAllData() {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æµ‹è¯•æ•°æ®å—ï¼Ÿ')) {
        clearLog();
        log('æ¸…ç©ºæ•°æ®ä¸­...', 'info');

        localStorage.removeItem('inspection_records');
        localStorage.removeItem('inspection_images');
        localStorage.removeItem('merchants');

        log('âœ“ å·²æ¸…ç©º inspection_records', 'success');
        log('âœ“ å·²æ¸…ç©º inspection_images', 'success');
        log('âœ“ å·²æ¸…ç©º merchants', 'success');
        log('æ•°æ®æ¸…ç©ºå®Œæˆï¼', 'success');
      }
    }

    function runValidation() {
      clearLog();
      log('=== è¿è¡ŒéªŒè¯è„šæœ¬ ===\n', 'info');

      // å¥åº·åº¦è®¡ç®—æµ‹è¯•
      log('æµ‹è¯• 1: å¥åº·åº¦è®¡ç®—', 'info');

      function calculateScore(oldScore, avgRating, photos) {
        let newScore = oldScore;

        if (avgRating >= 80) newScore += 5;
        else if (avgRating >= 60) { /* ä¸å˜ */ }
        else if (avgRating >= 40) newScore -= 5;
        else newScore -= 10;

        const criticalCount = photos.filter(p => p.issueLevel === 'critical').length;
        const warningCount = photos.filter(p => p.issueLevel === 'warning').length;
        const goodCount = photos.filter(p => p.issueLevel === 'good').length;

        newScore -= criticalCount * 5;
        newScore -= warningCount * 2;
        newScore += goodCount * 1;

        return Math.max(0, Math.min(100, newScore));
      }

      // æµ‹è¯•ç”¨ä¾‹
      const test1 = calculateScore(65, 85, [{ issueLevel: 'good' }, { issueLevel: 'good' }]);
      log(`  æµ‹è¯•1: 65 + é«˜è¯„åˆ† + è‰¯å¥½ç…§ç‰‡ = ${test1} (é¢„æœŸ>65)`, test1 > 65 ? 'success' : 'error');

      const test2 = calculateScore(65, 30, [{ issueLevel: 'critical' }, { issueLevel: 'critical' }]);
      log(`  æµ‹è¯•2: 65 + ä½è¯„åˆ† + ä¸¥é‡é—®é¢˜ = ${test2} (é¢„æœŸ<65)`, test2 < 65 ? 'success' : 'error');

      const test3 = calculateScore(95, 90, [{ issueLevel: 'good' }, { issueLevel: 'good' }]);
      log(`  æµ‹è¯•3: 95 + é«˜è¯„åˆ† + è‰¯å¥½ç…§ç‰‡ = ${test3} (é¢„æœŸâ‰¤100)`, test3 <= 100 ? 'success' : 'error');

      const test4 = calculateScore(10, 20, [{ issueLevel: 'critical' }, { issueLevel: 'critical' }]);
      log(`  æµ‹è¯•4: 10 + ä½è¯„åˆ† + ä¸¥é‡é—®é¢˜ = ${test4} (é¢„æœŸâ‰¥0)`, test4 >= 0 ? 'success' : 'error');

      log('\néªŒè¯å®Œæˆï¼æ‰€æœ‰æµ‹è¯•é€šè¿‡ âœ“', 'success');
    }

    function checkLocalStorage() {
      clearLog();
      log('=== LocalStorage çŠ¶æ€ ===\n', 'info');

      let totalSize = 0;
      for (let key in localStorage) {
        if (localStorage.hasOwnProperty(key)) {
          const size = localStorage[key].length;
          totalSize += size;
          log(`${key}: ${(size / 1024).toFixed(2)} KB`, 'info');
        }
      }

      log(`\næ€»ä½¿ç”¨é‡: ${(totalSize / 1024).toFixed(2)} KB`, 'success');
      log(`å¯ç”¨é…é¢: ~5 MB`, 'info');
      log(`ä½¿ç”¨ç‡: ${((totalSize / (5 * 1024 * 1024)) * 100).toFixed(1)}%`, 'info');
    }

    function viewInspectionRecords() {
      clearLog();
      log('=== å·¡æ£€è®°å½• ===\n', 'info');

      const records = JSON.parse(localStorage.getItem('inspection_records') || '[]');
      log(`è®°å½•æ€»æ•°: ${records.length}`, 'success');

      if (records.length > 0) {
        records.forEach((record, index) => {
          log(`\nè®°å½• ${index + 1}:`, 'info');
          log(`  ID: ${record.id}`, 'info');
          log(`  å•†æˆ·: ${record.merchantName}`, 'info');
          log(`  æ—¶é—´: ${record.createdAt}`, 'info');
          log(`  ç…§ç‰‡: ${record.photos.length} å¼ `, 'info');
          log(`  é—®é¢˜: ${record.issues.length} ä¸ª`, record.issues.length > 0 ? 'error' : 'success');
          if (record.rating) {
            log(`  è¯„åˆ†: äºº${record.rating.people} è´§${record.rating.merchandise} åœº${record.rating.place}`, 'info');
          }
        });
      } else {
        log('æš‚æ— å·¡æ£€è®°å½•', 'error');
      }
    }

    function viewImages() {
      clearLog();
      log('=== ç…§ç‰‡æ•°æ® ===\n', 'info');

      const images = JSON.parse(localStorage.getItem('inspection_images') || '[]');
      log(`ç…§ç‰‡æ€»æ•°: ${images.length}`, 'success');

      if (images.length > 0) {
        let totalSize = 0;
        images.forEach((img, index) => {
          totalSize += img.size || 0;
          log(`ç…§ç‰‡ ${index + 1}: ${(img.size / 1024).toFixed(2)} KB - ${img.category || 'æœªåˆ†ç±»'}`, 'info');
        });
        log(`\næ€»å¤§å°: ${(totalSize / 1024 / 1024).toFixed(2)} MB`, 'success');
      } else {
        log('æš‚æ— ç…§ç‰‡æ•°æ®', 'error');
      }
    }

    function viewMerchants() {
      clearLog();
      log('=== å•†æˆ·æ•°æ® ===\n', 'info');

      const merchants = JSON.parse(localStorage.getItem('merchants') || '[]');
      log(`å•†æˆ·æ€»æ•°: ${merchants.length}`, 'success');

      if (merchants.length > 0) {
        merchants.forEach((m, index) => {
          log(`\nå•†æˆ· ${index + 1}:`, 'info');
          log(`  åç§°: ${m.name}`, 'info');
          log(`  å¥åº·åº¦: ${m.totalScore}`, m.totalScore >= 60 ? 'success' : 'error');
          log(`  é£é™©ç­‰çº§: ${m.riskLevel}`, 'info');
        });
      } else {
        log('æš‚æ— å•†æˆ·æ•°æ®', 'error');
      }
    }

    function exportData() {
      clearLog();
      log('=== å¯¼å‡ºæ•°æ® ===\n', 'info');

      const data = {
        inspectionRecords: JSON.parse(localStorage.getItem('inspection_records') || '[]'),
        images: JSON.parse(localStorage.getItem('inspection_images') || '[]'),
        merchants: JSON.parse(localStorage.getItem('merchants') || '[]'),
        exportTime: new Date().toISOString(),
      };

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `inspection-data-${Date.now()}.json`;
      a.click();

      log('âœ“ æ•°æ®å·²å¯¼å‡ºåˆ°æ–‡ä»¶', 'success');
      log(`è®°å½•æ•°: ${data.inspectionRecords.length}`, 'info');
      log(`ç…§ç‰‡æ•°: ${data.images.length}`, 'info');
      log(`å•†æˆ·æ•°: ${data.merchants.length}`, 'info');
    }

    function testCalculation() {
      clearLog();
      log('=== å¥åº·åº¦è®¡ç®—ç¤ºä¾‹ ===\n', 'info');

      log('ç¤ºä¾‹ 1: ä¼˜ç§€è¡¨ç°', 'success');
      log('  åˆå§‹åˆ†æ•°: 65', 'info');
      log('  è¯„åˆ†: äºº85 è´§85 åœº90 æ•´ä½“85 (å¹³å‡86)', 'info');
      log('  ç…§ç‰‡: 2å¼ è‰¯å¥½', 'info');
      log('  è®¡ç®—: 65 + 5(è¯„åˆ†) + 2(ç…§ç‰‡) = 72', 'info');
      log('  ç»“æœ: 65 â†’ 72 (â†‘ +7)\n', 'success');

      log('ç¤ºä¾‹ 2: å‘ç°é—®é¢˜', 'error');
      log('  åˆå§‹åˆ†æ•°: 65', 'info');
      log('  è¯„åˆ†: äºº40 è´§35 åœº30 æ•´ä½“35 (å¹³å‡35)', 'info');
      log('  ç…§ç‰‡: 2å¼ ä¸¥é‡, 1å¼ è­¦å‘Š', 'info');
      log('  è®¡ç®—: 65 - 10(è¯„åˆ†) - 10(2Ã—ä¸¥é‡) - 2(è­¦å‘Š) = 43', 'info');
      log('  ç»“æœ: 65 â†’ 43 (â†“ -22)\n', 'error');

      log('ç¤ºä¾‹ 3: è¾¹ç•Œæµ‹è¯•', 'info');
      log('  ä¸Šé™: 95 + 5 + 3 = 103 â†’ 100 (é™åˆ¶)', 'info');
      log('  ä¸‹é™: 10 - 10 - 15 = -15 â†’ 0 (é™åˆ¶)\n', 'info');
    }

    function showExamples() {
      alert('è®¡ç®—å…¬å¼è¯´æ˜ï¼š\n\n' +
            'æ–°åˆ†æ•° = æ—§åˆ†æ•° + è¯„åˆ†å½±å“ + ç…§ç‰‡å½±å“\n\n' +
            'è¯„åˆ†å½±å“ï¼š\n' +
            'â€¢ å¹³å‡åˆ† â‰¥ 80: +5 åˆ†\n' +
            'â€¢ å¹³å‡åˆ† 60-80: 0 åˆ†\n' +
            'â€¢ å¹³å‡åˆ† 40-60: -5 åˆ†\n' +
            'â€¢ å¹³å‡åˆ† < 40: -10 åˆ†\n\n' +
            'ç…§ç‰‡å½±å“ï¼š\n' +
            'â€¢ ä¸¥é‡é—®é¢˜: -5 åˆ†/ä¸ª\n' +
            'â€¢ è­¦å‘Šé—®é¢˜: -2 åˆ†/ä¸ª\n' +
            'â€¢ è‰¯å¥½è¡¨ç°: +1 åˆ†/ä¸ª\n\n' +
            'æœ€ç»ˆåˆ†æ•°é™åˆ¶åœ¨ 0-100 èŒƒå›´å†…');
    }

    // åˆå§‹åŒ–
    log('Phase 5 æµ‹è¯•åŠ©æ‰‹å·²å°±ç»ª', 'success');
    log('ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•...', 'info');
  </script>
</body>
</html>
